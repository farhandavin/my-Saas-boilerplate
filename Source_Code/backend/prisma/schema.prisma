// backend/prisma/schema.prisma

generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["postgresqlExtensions"] // Required for vector support
}

datasource db {
  provider   = "postgresql"
  url        = env("DATABASE_URL")
  directUrl  = env("DIRECT_URL")
  extensions = [vector] // Activates pgvector for RAG (AI Memory)
}

// ==============================================================================
// 1. IDENTITY & ACCESS (User Management)
// ==============================================================================

model User {
  id       String  @id @default(cuid())
  email    String  @unique
  name     String?
  image    String? @db.Text
  password String? // Nullable because SSO users won't have a password here

  // --- SSO FIELDS ---
  provider   String  @default("email") // "email" or "google"
  providerId String? // The unique ID from Google/GitHub

  // --- RELATIONS ---
  teamMembers   TeamMember[]
  auditLogs     AuditLog[]
  notifications Notification[] // User receives alerts here

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model TeamMember {
  id   String @id @default(cuid())
  role String @default("MEMBER") // ENUM: OWNER, ADMIN, MEMBER, VIEWER

  userId String
  teamId String

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  team Team @relation(fields: [teamId], references: [id], onDelete: Cascade)

  @@unique([userId, teamId]) // One user, one role per team
  @@index([userId])
  @@index([teamId])
}

model Invitation {
  id      String   @id @default(cuid())
  email   String
  role    String   @default("MEMBER")
  token   String   @unique
  expires DateTime

  teamId String
  team   Team   @relation(fields: [teamId], references: [id], onDelete: Cascade)

  @@unique([teamId, email])
}

// ==============================================================================
// 2. THE TENANT (The "Digital Office")
// ==============================================================================

model Team {
  id   String @id @default(cuid())
  name String
  slug String @unique // URL friendly: app.com/team-slug

  // --- PILLAR 3: BILLING (Stripe) ---
  stripeCustomerId     String? @unique
  stripeSubscriptionId String?

  // Tier: "FREE" (Shared), "PRO" (Schema Separation), "ENTERPRISE" (Dedicated DB)
  tier String @default("FREE")

  // --- PILLAR 2: INFRASTRUCTURE ---
  // If ENTERPRISE, this is filled. If FREE/PRO, it is null (uses default DB).
  databaseUrl String? @db.Text

  // --- PILLAR 1: AI INTELLIGENCE ---
  aiUsageCount Int @default(0)    // Tokens used this month
  aiTokenLimit Int @default(1000) // Quota cap based on plan

  // --- RELATIONS ---
  members       TeamMember[]
  invitations   Invitation[]
  auditLogs     AuditLog[]
  documents     Document[]     // Knowledge Base for RAG
  apiKeys       ApiKey[]       // For programmatic access
  notifications Notification[] // Team-wide alerts

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// ==============================================================================
// 3. AI & KNOWLEDGE BASE (RAG)
// ==============================================================================

model Document {
  id      String @id @default(cuid())
  teamId  String
  title   String
  content String @db.Text

  // Stores vector embedding for smart search.
  // NOTE: Use vector(768) for Gemini 1.5 Flash/Embedding-004
  // NOTE: Use vector(1536) for OpenAI Ada-002
  embedding Unsupported("vector(768)")? 

  team Team @relation(fields: [teamId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
}

// ==============================================================================
// 4. SECURITY & COMPLIANCE
// ==============================================================================

model ApiKey {
  id   String @id @default(cuid())
  name String // Label, e.g., "Zapier Connection"

  // We store the prefix so users can identify the key in UI (e.g., "sk_live_abc1...")
  prefix String

  // The hashed key (SHA256). The real key is never stored.
  keyHash String @unique

  lastUsedAt DateTime?

  teamId String
  team   Team   @relation(fields: [teamId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
}

model AuditLog {
  id        String  @id @default(cuid())
  teamId    String
  userId    String
  action    String  // e.g., "LOGIN", "DELETE_DOC", "UPGRADE_PLAN"
  resource  String? // ID of the item changed
  details   String? @db.Text
  ipAddress String?

  team Team @relation(fields: [teamId], references: [id], onDelete: Cascade)
  user User @relation(fields: [userId], references: [id])

  createdAt DateTime @default(now())
}

// ==============================================================================
// 5. USER ENGAGEMENT
// ==============================================================================

model Notification {
  id     String @id @default(cuid())
  userId String // Recipient
  teamId String // Context

  title   String
  message String  @db.Text
  type    String  @default("INFO") // INFO, WARNING, SUCCESS, UPSELL
  isRead  Boolean @default(false)

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  team Team @relation(fields: [teamId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
}